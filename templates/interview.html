
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            text-align: center;
        }
        #videoPlayer{
            height: 70vh;
            width: 85vw;
            margin: 25px auto;
        }
        button{
            font-size: 16px;
            padding: 2px 4px;
        }
        #changeButton{
            display: none;
        }
        #instructions{
            color: tomato;
        }
        #userVideo{
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 250px;
            height: 150px;
            transform: scaleX(-1);
        }
    </style>
</head>
<body>

    <video name='demo' autoplay="true" id="videoPlayer">
        <source src="../static/interview_questions/{{start}}" type="video/mp4" id="vidSource"/>
    </video><br>

    <video controls muted id="userVideo"></video>

    <button onclick="onStart()" id="startButton">Start Interview</button>
    
    
    <h3 id="instructions"></h3><br>

    <button id="changeButton">End Answer and Start Next Question</button>





    <script>

        let constraintObj = { 
            audio: true,
            video: { 
                facingMode: "user", 
                width: { min: 640, ideal: 1280, max: 1920 },
                height: { min: 480, ideal: 720, max: 1080 } 
            } 
        }; 

        var arr = JSON.parse('{{ videos|safe }}')
        var numberOfVideos = arr.length;
        
        var count=0;
        var player = document.getElementById('videoPlayer');
        var videoSource = document.getElementById('vidSource');
        var changeButton = document.getElementById('changeButton');
        var instructions = document.getElementById('instructions');

        player.pause();

        //handle older browsers that might implement getUserMedia in some way
        if (navigator.mediaDevices === undefined) {
            navigator.mediaDevices = {};
            navigator.mediaDevices.getUserMedia = function(constraintObj) {
                let getUserMedia = navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
                if (!getUserMedia) {
                    return Promise.reject(new Error('getUserMedia is not implemented in this browser'));
                }
                return new Promise(function(resolve, reject) {
                    getUserMedia.call(navigator, constraintObj, resolve, reject);
                });
            }
        }else{
            navigator.mediaDevices.enumerateDevices()
            .then(devices => {
                devices.forEach(device=>{
                    //console.log(device.kind.toUpperCase(), device.label);
                    //, device.deviceId
                })
            })
            .catch(err=>{
                console.log(err.name, err.message);
            })
        }

        navigator.mediaDevices.getUserMedia(constraintObj)
        .then(function(mediaStreamObj) {
            //connect the media stream to the first video element
            let video = document.getElementById("userVideo");

            if ("srcObject" in video) {
                video.srcObject = mediaStreamObj;
            } else {
                //old version
                video.src = window.URL.createObjectURL(mediaStreamObj);
            }
            
            video.onloadedmetadata = function(ev) {
                //show in the video element what is being captured by the webcam
                video.play();
            };

            //add listeners for saving video/audio
            let mediaRecorder = new MediaRecorder(mediaStreamObj);
            let chunks = [];
            
            player.addEventListener('ended', (ev)=>{
                mediaRecorder.start();
                console.log(mediaRecorder.state);
                instructions.innerHTML = "Recording Your Answer...";
                changeButton.style.display = 'inline';
            })
            changeButton.addEventListener('click', (ev)=>{
                mediaRecorder.stop();
                console.log(mediaRecorder.state);
            });

            mediaRecorder.ondataavailable = function(ev) {
                chunks.push(ev.data);
            }

            mediaRecorder.onstop = (ev)=>{
                let blob = new Blob(chunks, { 'type' : 'video/mp4;' });
                chunks = [];

                var formData = new FormData();
                formData.append("blob", blob);
                formData.append("qs", count);
                var xhr = new XMLHttpRequest();
                xhr.open('POST', "{% url 'interview:interview' %}", true);
                xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
                xhr.send(formData);
                console.log("Video recoreded and sent for Question Number: " + count);
            }
        })

        .catch(function(err) { 
            console.log(err.name, err.message); 
        });

        changeButton.addEventListener('click',nextButtonClickFunction,false);

        function onStart(){
            document.getElementById('videoPlayer').play();
            document.getElementById('startButton').style.display = 'none';
        }
    
        function nextButtonClickFunction(e){
            changeButton.style.display = "none"
            instructions.innerHTML = ""

            if(!e) 
            {
                e = window.event; 
            }

            count++;

            if(count == numberOfVideos-1){
                changeButton.innerText = "End Answer";
            }

            if(count>=numberOfVideos){
                instructions.innerHTML = "Interview Over!";
                window.location.href = "/interview_success/";
            }
            else{
                videoSource.src = "../static/interview_questions/"+arr[count];
                player.load();
                player.play();
            }
        }

    </script>

</body>
    
</html>