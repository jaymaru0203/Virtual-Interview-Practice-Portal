{% extends "links.html" %}
{% block title %}Interview{% endblock %}

{% block head_content %}

    <style>
      body{
        margin:0;
      }
      .wrapper {
        display: flex;
        width: 100%;
        align-items: stretch;
       }
        #videoPlayer{
            height: 100vh;
            object-fit: cover;
            width: 100%;
            overflow: hidden;
        }
        .button{
            font-size: 16px;
            padding: 2px 4px;
            position:absolute;
            bottom:5px;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        #changeButton{
            display: none;
        }
        #instructions{
            color : #fff;
            z-index: 5;
            position:absolute;
            bottom:100px;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        #userVideo{
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 250px;
            height: 150px;
            z-index: 5;
            transform: scaleX(-1);
        }
        .hire-mech{
          width: 200px;
          border: none;
          padding: 12px 8px;
          margin: 10px 0;
          border-radius:8px;
          background-color:  #A43FDD;
          color: #fff;
          font-size: 1.2rem;
        }

        #questions{
            color : #000;
            z-index: 5;
            position: absolute;
            bottom: 130px;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
        }
        .cross{
            z-index: 5;
            position: absolute;
            top: 30px;
            left: 30px;
            transform: translate(-50%, -50%);
            text-decoration: none;
            color: #444;
        }
        .cross:hover{
            text-decoration: none;
            color: #000;
        }

    </style>
{% endblock %}
{% block content %}
  <div class="wrapper">
      <a href="{% url 'interview:dashboard' %}" class="cross"><h4> X </h4></a>
    <video name='demo' autoplay="true" id="videoPlayer">
        <source src="../static/interview_questions/{{ request.session.choice }}/{{start}}" type="video/mp4" id="vidSource"/>
    </video><br>

    <video muted id="userVideo"></video>
    
    <button onclick="onStart()" id="startButton" class="hire-mech button">Start Interview</button>
    
    <h4 id="questions"></h4>

    <h3 id="instructions"></h3><br>
    <button id="changeButton" class= "hire-mech button">End Answer</button>

  </div>



    <script>

        let constraintObj = { 
            audio: true,
            video: { 
                facingMode: "user", 
                width: { min: 640, ideal: 1280, max: 1920 },
                height: { min: 480, ideal: 720, max: 1080 } 
            } 
        }; 
        var videos_array = JSON.parse('{{ videos|safe }}')
        var questions_array = JSON.parse('{{ questions|safe }}')
        console.log(questions_array)

        var numberOfVideos = videos_array.length;
        var count=0;

        var player = document.getElementById('videoPlayer');
        var videoSource = document.getElementById('vidSource');
        var changeButton = document.getElementById('changeButton');
        var instructions = document.getElementById('instructions');
        var questions = document.getElementById('questions');

        player.pause();

        //handle older browsers that might implement getUserMedia in some way
        if (navigator.mediaDevices === undefined) {
            navigator.mediaDevices = {};
            navigator.mediaDevices.getUserMedia = function(constraintObj) {
                let getUserMedia = navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
                if (!getUserMedia) {
                    return Promise.reject(new Error('getUserMedia is not implemented in this browser'));
                }
                return new Promise(function(resolve, reject) {
                    getUserMedia.call(navigator, constraintObj, resolve, reject);
                });
            }
        }else{
            navigator.mediaDevices.enumerateDevices()
            .then(devices => {
                devices.forEach(device=>{
                    //console.log(device.kind.toUpperCase(), device.label);
                    //, device.deviceId
                })
            })
            .catch(err=>{
                console.log(err.name, err.message);
            })
        }

        navigator.mediaDevices.getUserMedia(constraintObj)
        .then(function(mediaStreamObj) {
            //connect the media stream to the first video element
            let video = document.getElementById("userVideo");

            if ("srcObject" in video) {
                video.srcObject = mediaStreamObj;
            } else {
                //old version
                video.src = window.URL.createObjectURL(mediaStreamObj);
            }
            
            video.onloadedmetadata = function(ev) {
                //show in the video element what is being captured by the webcam
                video.play();
            };

            //add listeners for saving video/audio
            let mediaRecorder = new MediaRecorder(mediaStreamObj);
            let chunks = [];
            
            player.addEventListener('ended', (ev)=>{
                mediaRecorder.start();
                console.log(mediaRecorder.state);
                instructions.innerHTML = "Recording Your Answer...";
                changeButton.style.display = 'inline';
            })
            changeButton.addEventListener('click', (ev)=>{
                mediaRecorder.stop();
                console.log(mediaRecorder.state);
            });

            mediaRecorder.ondataavailable = function(ev) {
                chunks.push(ev.data);
            }

            mediaRecorder.onstop = (ev)=>{
                if(count == numberOfVideos-1){
                    instructions.innerHTML = "Interview Over! Redirecting in 3 seconds...";
                    setTimeout(()=>{window.location.href = "/interview_success/";}, 9000)
                }
                let blob = new Blob(chunks, { 'type' : 'video/mp4;' });
                chunks = [];

                var formData = new FormData();
                formData.append("blob", blob);
                formData.append("qs", count);
                var xhr = new XMLHttpRequest();
                xhr.open('POST', "{% url 'interview:interview' %}", true);
                xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
                xhr.send(formData);
                console.log("Video recoreded and sent for Question Number: " + count);
            }
        })

        .catch(function(err) { 
            console.log(err.name, err.message); 
        });

        changeButton.addEventListener('click',nextButtonClickFunction,false);

        function onStart(){
            document.getElementById('videoPlayer').play();
            document.getElementById('startButton').style.display = 'none';
            questions.innerHTML = questions_array[count]
        }
    
        function nextButtonClickFunction(e){
            changeButton.style.display = "none"
            instructions.innerHTML = ""

            if(!e) 
            {
                e = window.event; 
            }

            count++;

            if(count == numberOfVideos-1){
                changeButton.innerText = "End Answer";
            }

            if(count>=numberOfVideos){
                instructions.innerHTML = "Interview Over!";
                window.location.href = "/interview_success/";
            }
            else{
                questions.innerHTML = questions_array[count]
                videoSource.src = "../static/interview_questions/{{request.session.choice}}/"+videos_array[count];
                player.load();
                player.play();
            }
        }

    </script>

{%  endblock %}